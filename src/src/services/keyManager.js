// src/services/keyManager.js
import CryptoJS from 'crypto-js';
import * as bip39 from 'bip39';
import HDKey from 'hdkey';

class KeyManager {
  constructor() {
      this.encryptionKey = null;
        }

          // üîê Mnemonic phrase generate ⁄©ÿ±€å⁄∫ (12 words)
            generateMnemonic() {
                try {
                      const mnemonic = bip39.generateMnemonic();
                            console.log('‚úÖ Mnemonic generated successfully - keyManager.js:15');
                                  return mnemonic;
                                      } catch (error) {
                                            console.error('‚ùå Error generating mnemonic: - keyManager.js:18', error);
                                                  throw new Error('Failed to generate mnemonic');
                                                      }
                                                        }

                                                          // üîë Mnemonic ÿ≥€í wallet ÿ®ŸÜÿßÿ¶€å⁄∫
                                                            createWalletFromMnemonic(mnemonic, password) {
                                                                try {
                                                                      // Validate mnemonic
                                                                            if (!bip39.validateMnemonic(mnemonic)) {
                                                                                    throw new Error('Invalid mnemonic phrase');
                                                                                          }

                                                                                                // Generate seed from mnemonic
                                                                                                      const seed = bip39.mnemonicToSeedSync(mnemonic);
                                                                                                            
                                                                                                                  // Create HD wallet
                                                                                                                        const hdkey = HDKey.fromMasterSeed(seed);
                                                                                                                              
                                                                                                                                    // Derive first account (m/44'/60'/0'/0/0 - Ethereum path)
                                                                                                                                          const wallet = hdkey.derive("m/44'/60'/0'/0/0");
                                                                                                                                                
                                                                                                                                                      const walletData = {
                                                                                                                                                              address: `0x${wallet.publicKey.toString('hex')}`,
                                                                                                                                                                      privateKey: wallet.privateKey.toString('hex'),
                                                                                                                                                                              publicKey: wallet.publicKey.toString('hex'),
                                                                                                                                                                                      mnemonic: mnemonic
                                                                                                                                                                                            };

                                                                                                                                                                                                  // Encrypt private data
                                                                                                                                                                                                        const encryptedData = this.encryptWalletData(walletData, password);
                                                                                                                                                                                                              
                                                                                                                                                                                                                    console.log('‚úÖ Wallet created successfully - keyManager.js:50');
                                                                                                                                                                                                                          return {
                                                                                                                                                                                                                                  address: walletData.address,
                                                                                                                                                                                                                                          encrypted: encryptedData
                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                          console.error('‚ùå Error creating wallet: - keyManager.js:56', error);
                                                                                                                                                                                                                                                                throw error;
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                        // üîí Wallet data encrypt ⁄©ÿ±€å⁄∫
                                                                                                                                                                                                                                                                          encryptWalletData(walletData, password) {
                                                                                                                                                                                                                                                                              try {
                                                                                                                                                                                                                                                                                    const dataString = JSON.stringify(walletData);
                                                                                                                                                                                                                                                                                          const encrypted = CryptoJS.AES.encrypt(dataString, password).toString();
                                                                                                                                                                                                                                                                                                return encrypted;
                                                                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                                                                          console.error('‚ùå Encryption error: - keyManager.js:68', error);
                                                                                                                                                                                                                                                                                                                throw new Error('Failed to encrypt wallet data');
                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                        // üîì Wallet data decrypt ⁄©ÿ±€å⁄∫
                                                                                                                                                                                                                                                                                                                          decryptWalletData(encryptedData, password) {
                                                                                                                                                                                                                                                                                                                              try {
                                                                                                                                                                                                                                                                                                                                    const decrypted = CryptoJS.AES.decrypt(encryptedData, password);
                                                                                                                                                                                                                                                                                                                                          const decryptedString = decrypted.toString(CryptoJS.enc.Utf8);
                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                      if (!decryptedString) {
                                                                                                                                                                                                                                                                                                                                                              throw new Error('Invalid password or corrupted data');
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                return JSON.parse(decryptedString);
                                                                                                                                                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                          console.error('‚ùå Decryption error: - keyManager.js:85', error);
                                                                                                                                                                                                                                                                                                                                                                                                throw new Error('Failed to decrypt wallet data');
                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                        // üíæ Wallet ⁄©Ÿà local storage ŸÖ€å⁄∫ ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫
                                                                                                                                                                                                                                                                                                                                                                                                          saveWallet(walletData, walletName = 'default') {
                                                                                                                                                                                                                                                                                                                                                                                                              try {
                                                                                                                                                                                                                                                                                                                                                                                                                    const walletKey = `wallet_${walletName}`;
                                                                                                                                                                                                                                                                                                                                                                                                                          localStorage.setItem(walletKey, JSON.stringify(walletData));
                                                                                                                                                                                                                                                                                                                                                                                                                                console.log('‚úÖ Wallet saved to localStorage - keyManager.js:95');
                                                                                                                                                                                                                                                                                                                                                                                                                                      return true;
                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error('‚ùå Error saving wallet: - keyManager.js:98', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                      return false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                              // üìÇ ŸÖÿ≠ŸÅŸàÿ∏ ÿ¥ÿØ€Å wallet ŸÑŸà⁄à ⁄©ÿ±€å⁄∫
                                                                                                                                                                                                                                                                                                                                                                                                                                                                loadWallet(walletName = 'default') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const walletKey = `wallet_${walletName}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const walletData = localStorage.getItem(walletKey);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!walletData) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return JSON.parse(walletData);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error('‚ùå Error loading wallet: - keyManager.js:115', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            export default KeyManager;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            